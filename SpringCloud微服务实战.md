# SpringCloud微服务实战

## 基础知识

### 微服务架构

将一个原本独立的系统拆分成多个小型服务，这些小型服务都在各自独立的进程中运行，服务之间通过基于HTTP的Restful API进行通信协作，被拆分成的每一个小型服务都围绕着系统中的某一项或一些耦合度较高的业务功能进行构建，并且每个服务都维护着自身的数据存储、业务开发、自动化测试案例以及独立部署机制。

**微服务带来的问题**

- 运维的新挑战：运维人员需要维护的进程数量大大增加；
- 接口的一致性：需要更完善的接口和版本管理，或是严格地遵循开闭原则；
- 分布式地复杂性：网络延迟、分布式事务、异步消息等；

**微服务架构9大特性**

- **服务组件化**：对服务进行组件化分解，每个服务独立开发、部署，可以有效避免一个服务的修改引起整个系统的重新部署；
- **按业务组织团队**：不再按职能，而是业务线；
- **做产品的态度**：需要用做“产品”的态度来对待每一个微服务，持续关注服务的运作情况，并不断分析以帮助用户来改善业务功能；
- **智能端点与哑管道**：在微服务架构中，通常会使用以下两种服务调用方式：1.使用HTTP的RESTful API或轻量级的消息发送协议，实现消息传递与服务调用的触发。2.通过在轻量级消息总线上传递消息，类似RabbitMQ等一些提供可靠异步交换的中间件；
- **去中心化治理**：微服务架构系统中的各个组件能针对不同的业务特点选择不同的技术平台；
- **去中心化管理数据**：每个服务管理其自有的数据库。数据管理的去中心化使数据管理更加细致化，通过采用更合适的技术可让数据存储和性能达到最优，但是数据一致性成为亟待解决的问题之一；
- **基础设施自动化**：在微服务架构中，务必从一开始就构建起“持续交付”平台来支撑整个实施过程，该平台需要自动化测试和自动化部署两大内容；
- **容错设计**：在微服务架构中，快速检测出故障源并尽可能地自动恢复服务是必须被设计和考虑的。通常，我们都希望在每个服务中实现监控和日志记录的组件，比如服务状态、断路器状态、吞吐量、网络延迟等关键数据的仪表盘等；
- **演进式设计**：在初期以单体系统的方式来设计和实施，随着业务的发展将原来多变的模块逐步拆分出来；

### Spring Cloud简介

Spring Cloud是一个基于Spring Boot实现的微服务架构开发工具。它为微服务架构中涉及的配置管理、服务治理、断路器、智能路由、微代理、控制总线、全局锁、决策竞选、分布式会话和集群状态管理等操作提供了一种简单的开发方式。

Spring Cloud Netflix：核心组件，对多个Netflix OSS开源套件进行整合：

- Eureka：服务治理组件，包含服务注册中心、服务注册与发现机制的实现；
- Hystrix：容错管理组件，实现断路器模式，帮助服务依赖中出现的延迟和为故障提供强大的容错能力；
- Ribbon：客户端负载均衡的服务调用组件；
- Feign：基于Ribbon和Hystrix的声明式服务调用组件；
- Zuul：网关组件，提供智能路由、访问过滤等功能；
- Archaius：外部化配置组件；

## 微服务构建：Spring Boot

### 配置详解

#### 参数引用

使用${valueName}引用

#### 使用随机数

通过${random.value}、${random.int}、${random.long}

#### 加载顺序

1. 在命令行中传入的参数，如server.port；
2. SPRING_APPLICATION_JSON中的属性，SPRING_APPLICATION_JSON是以JSON格式配置在系统环境变量中的内容；
3. java:comp/env中的JNDI属性；
4. Java的系统属性，可以通过System.getProperties()获得的内容；
5. 操作系统的环境变量；
6. 通过random.*配置的随机属性；
7. 位于当前应用jar包**之外**，针对不同{profile}环境的配置文件内容；
8. 位于当前应用jar包**之内**，针对不同{profile}环境的配置文件内容；
9. 位于当前应用jar包**之外**的application.properties或YAML配置内容；
10. 位于当前应用jar包**之内**的application.properties或YAML配置内容；
11. 在@Configuration注解修改的类中，通过@Properties注解定义的属性；
12. 应用默认属性，使用SpringApplication.setDefaultProperties定义的内容；

### 监控与管理

#### 原生端点

- **应用配置类**：获取应用程序中加载的应用配置、环境变量、自动化配置报告等与Spring Boot应用密切相关的配置类信息；
- **度量指标类**：获取应用程序运行过程中用于监控的度量指标，比如内存信息、线程池信息、HTTP请求统计等；
- **操作控制类**：提供了对应用的关闭等操作类功能；

## 服务治理：Spring Cloud Eureka

### 服务治理

服务治理是微服务架构中最为核心和基础的模块，它主要用来实现各个微服务实例的自动化注册与发现。

**服务注册**：在服务治理框架中，通常都会构建一个注册中心，每个服务单元向注册中心登记自己提供的服务，将主机与端口号、版本号、通信协议等一些附加信息告知注册中心，注册中心按服务名分类组织服务清单。服务注册中心还需要以心跳的方式去检测清单中的服务是否可用，若不可用需要从服务清单中剔除，达到排除故障服务的效果；

**服务发现**：在服务治理框架下运作，服务间的调用不再通过指定具体的实体地址来实现，而是通过向服务名发起请求调用实现，服务调用方在调用接口时并不知道具体的服务实例位置，因此调用方需要服务注册中心咨询服务，并获取所有服务的实例清单，以实现对具体服务实例的访问；

### Netflix Eureka

- **Eureka服务端**：服务注册中心，支持高可用配置，依托于强一致性提供良好的服务实例可用性。如果Eureka以集群模式部署，当集群中有分片出现故障时，那么Eureka就转入自我保护模式，它允许在分片故障期间继续提供服务的发现和注册，当故障分片恢复运行时，集群中的其他分片会把它们的状态再次同步回来；
- **Eureka客户端**：主要处理服务的注册与发现，客户端通过注解和参数配置的方式，嵌入在客户端应用程序的代码中，在应用程序运行时，Eureka客户端向注册中心注册自身提供的服务并周期性地发送心跳来更新它地服务租约。同时，它也能从服务端查询当前注册的服务信息并把它们缓存到本地并周期性地刷新服务状态；